<!DOCTYPE html>
<html>
	<head>
		<title>NRK Nettradio</title>
        <meta name="msapplication-navbutton-color" content="black" />
        <meta name="msapplication-tooltip" content="Spill nettradio fra NRK" />
        <meta name="msapplication-window" content="width=320;height=280" />
        <meta name="msapplication-navbutton-color" content="black" />

		<link rel="stylesheet" href="../css/style.css">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
		<script src="../js/jquery.tmpl.js"></script>
        <script src="../js/h5utils.js"></script>        
		<script src="../js/modernizr-1.5.js"></script>
        <script src="../js/modernizr-tests.js"></script>
        <style>
        
            .insitemode #install, 
            .no-sitemode #install
            {
                display: none;    
            }
           
        </style>
	</head>
	
	<body>

        <button id="install">Launch In Site Mode </button>
	
		<select>
			
		</select>
		
		<section>
			<div id="currentChannel"></div>
			<audio autoplay controls></audio>
		</section>	
		
		<script id="channelsTemplate" type="text/html">
            <option value="${name}">${channel}</option>
		</script>
		
		<script id="currentChannelTemplate" type="text/html">
			<header>
				<h1>${channel}</h1>
			</header>
			<img src="${logo}" />
		</script>
		
		<script>            
            var audio;
		    var channels;
			
			$(document).ready(function() {              
                audio = $("audio").get(0);            
                addEvent(audio, "play", function() { localStorage.setItem("state", "playing"); });
                addEvent(audio, "pause", function() { localStorage.setItem("state", "pausing"); });
                        
                jQuery.ajax({
					url: "feed.json",
					dataType: "json",
					success: stationsLoaded
				});                
            });	            		

			function stationsLoaded(result) {                
			    channels = result.station.channels;
                $("#channelsTemplate").tmpl(channels).appendTo("select");

			    if (Modernizr.insitemode) {
			        createJumpList();
			        createThumbToolbar();
			    };				

                var savedChannel = localStorage.getItem("selectedChannel");                
                if(savedChannel) {
                    $("select").val(savedChannel);                    
                } else {
                    $("select").val("P3");
                };
                showSelectedChannel();
                
                var playState = localStorage.getItem("state");
                if(playState && playState == "playing") {
                    playSelectedChannel();
                };
                                			
				$("select").change(function(e) {      
                    localStorage.setItem("selectedChannel", $(this).val());
                    showSelectedChannel();
					playSelectedChannel();
				});
			};

            function showSelectedChannel() {
                var channel = getSelectedChannel();
                $("#currentChannel").html("");
				$("#currentChannelTemplate").tmpl(channel).appendTo("#currentChannel");
            };        

            function playSelectedChannel() {
                var channel = getSelectedChannel();
				var streamUrl = Modernizr.audio.ogg ? channel.middle.ogg : channel.middle.mp3;
					
				if(streamUrl) {   
                    audio.pause();        
                    audio.src = streamUrl;   
                    audio.load();     
				};				
            };

            function getSelectedChannel() {
                return channels[$("select").get(0).selectedIndex];
            };            
            
            function createJumpList() {
                window.external.msSiteModeCreateJumplist("Radiokanaler");         
                for(var i = 0; i < channels.length; ++i) {
                    window.external.msSiteModeAddJumpListItem(channels[i].channel, "index.html#" + channels[i].name, "gfx/play.ico");
                };
                window.external.msSiteModeShowJumplist();
            }; 		
            
            function createThumbToolbar() {
                var prevButton = window.external.msSiteModeAddThumbBarButton("gfx/prev.ico", "Forrige");                
                var playPauseButton = window.external.msSiteModeAddThumbBarButton("gfx/play.ico", "Spill");                
                var nextButton = window.external.msSiteModeAddThumbBarButton("gfx/next.ico", "Neste");

                var stylePlay = window.external.msSiteModeAddButtonStyle(playPauseButton, "gfx/play.ico", "Spill");
			    var stylePause = window.external.msSiteModeAddButtonStyle(playPauseButton, "gfx/pause.ico", "Pause");

                window.external.msSiteModeShowThumbBar();
                
                addEvent(document, "msthumbnailclick", function(e) {
                    switch(e.buttonID) {
                        case playPauseButton:
                            if(audio.paused) audio.play();
                            else audio.pause();
                            break;
                        case prevButton: 
                            break;
                        default: break;
                    };
                });

                addEvent(audio, "play", function() {                     
                    window.external.msSiteModeShowButtonStyle(playPauseButton, stylePause);
                    window.external.msSiteModeSetIconOverlay("gfx/play.ico", "Spiller " + getSelectedChannel().channel);
                });

                addEvent(audio, "pause", function() {
                    window.external.msSiteModeShowButtonStyle(playPauseButton, stylePlay);
                    window.external.msSiteModeSetIconOverlay("gfx/pause.ico", "Pause " + getSelectedChannel().channel);
                });                
            };	
		
		</script>
		
	</body>
	
</html>

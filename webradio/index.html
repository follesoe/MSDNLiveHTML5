<!DOCTYPE html>
<html>
	<head>
		<title>NRK Nettradio</title>
        <meta name="msapplication-navbutton-color" content="black" />
        <meta name="msapplication-tooltip" content="Spill nettradio fra NRK" />
        <meta name="msapplication-window" content="width=320;height=280" />
        <meta name="msapplication-navbutton-color" content="black" />

		<link rel="stylesheet" href="../css/style.css">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
		<script src="../js/jquery.tmpl.js"></script>
        <script src="../js/h5utils.js"></script>        
		<script src="../js/modernizr-1.5.js"></script>
        <script src="../js/modernizr-tests.js"></script>
        <style>
        
            .insitemode #install, 
            .no-sitemode #install
            {
                display: none;    
            }
           
        </style>
	</head>
	
	<body>

        <button id="install">Launch In Site Mode </button>
	
		<select>
			
		</select>
		
		<section>
			<div id="currentChannel"></div>
			<audio autoplay controls></audio>
		</section>	
		
		<script id="channelsTemplate" type="text/html">
            <option value="${name}">${channel}</option>
		</script>
		
		<script id="currentChannelTemplate" type="text/html">
			<header>
				<h1>${channel}</h1>
			</header>
			<img src="${logo}" />
		</script>
		
		<script>            
            var audio;
		    var channels;
		    var currentIndex = -1;            
			
			$(document).ready(function() {                
                jQuery.ajax({
					url: "feed.json",
					dataType: "json",
					success: stationsLoaded
				});                
            });	            		

			function stationsLoaded(result) {
                console.log("ready!");                                                
                audio = $("audio").get(0);
			    channels = result.station.channels;

			    if (Modernizr.insitemode) {
			        createJumpList();
			        createThumbToolbar();
			    };

				$("#channelsTemplate").tmpl(channels).appendTo("select");
				
				$("select").change(function(e) {                    
					currentIndex = $(this).get(0).selectedIndex;
                    playChannel(currentIndex);					
				});
			};

            function playChannel(index) {
                var channel = channels[index];										
				var streamUrl;
										
				if(Modernizr.audio && Modernizr.audio.ogg) {
					streamUrl = channel.middle.ogg;
				} else if(Modernizr.audio && Modernizr.audio.mp3) {
					streamUrl = channel.middle.mp3;
				};					
					
				if(streamUrl) {   
                    audio.pause();        
                    audio.src = streamUrl;   
                    audio.load();     
				};
					
				$("#currentChannel").html("");
				$("#currentChannelTemplate").tmpl(channel).appendTo("#currentChannel");
            };
            
            function createJumpList() {
                window.external.msSiteModeCreateJumplist("Radiokanaler");         
                for(var i = 0; i < channels.length; ++i) {
                    window.external.msSiteModeAddJumpListItem(channels[i].channel, "index.html#" + channels[i].name, "gfx/play.ico");
                };
                window.external.msSiteModeShowJumplist();
            }; 		
            
            function createThumbToolbar() {
                var prevButton = window.external.msSiteModeAddThumbBarButton("gfx/prev.ico", "Forrige");                
                var playPauseButton = window.external.msSiteModeAddThumbBarButton("gfx/play.ico", "Spill");                
                var nextButton = window.external.msSiteModeAddThumbBarButton("gfx/next.ico", "Neste");

                var stylePlay = window.external.msSiteModeAddButtonStyle(playPauseButton, "gfx/play.ico", "Spill");
			    var stylePause = window.external.msSiteModeAddButtonStyle(playPauseButton, "gfx/pause.ico", "Pause");

                window.external.msSiteModeShowThumbBar();

                
                addEvent(document, "msthumbnailclick", function(e) {
                    switch(e.buttonID) {
                        case playPauseButton:
                            if(audio.paused) audio.play();
                            else audio.pause();
                            break;
                        case prevButton: 
                            break;
                        default: break;
                    };
                });

                addEvent(audio, "play", function() { 
                    window.external.msSiteModeShowButtonStyle(playPauseButton, stylePause);
                    window.external.msSiteModeSetIconOverlay("gfx/play.ico", "Spiller " + channels[currentIndex].channel);
                });

                addEvent(audio, "pause", function() {
                    window.external.msSiteModeShowButtonStyle(playPauseButton, stylePlay);
                    window.external.msSiteModeSetIconOverlay("gfx/pause.ico", "Pause " + channels[currentIndex].channel);
                });                
            };	
		
		</script>
		
	</body>
	
</html>
